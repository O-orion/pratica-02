name: CI/CD Pipeline - INDT

on:
    push:
        branches:
            - main

jobs:
    build-and-deply:
        runs-on: self-hosted
        
        steps:
            - name: Checkout do CÃ³digo
              uses: actions/checkout@v4
            
            - name: Restart Docker
              run: |
                   sudo /usr/local/bin/docker-restart.sh
                   sleep 10

            - name: Login no GitHub Container Registry
              run: |
                   echo "${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin"
            
            - name: Para Containers Antigos
              run: |
                   docker compose down|| true
            
            - name: Build da Image
              run: |
                   docker build-t ghcr.io/o-orion/aula-devops:latest .
            
            - name: Push pro ghcr.io
              run: |
                   docker push ghcr.io/o-orion/aula-devops:latest
            
            - name: Cria o .env na VM
              run: |
                cat > .env << EOF
                DB_HOST=postgres
                DB_PORT=${{ secrets.DB_PORT }}
                DB_USER=${{ secrets.DB_USER }}
                DB_PASS=${{ secrets.DB_PASS }}
                DB_NAME=${{ secrets.DB_NAME }}
                NODE_ENV=production
                PORT=6060
                JWT_ACCESS_SECRET=${{ secrets.JWT_ACCESS_SECRET }}
                JWT_ACCESS_EXPIRATION=15m
                JWT_REFRESH_SECRET=${{ secrets.JWT_REFRESH_SECRET }}
                JWT_REFRESH_EXPIRATION=7d
                EOF
            
            - name: Sobe com Docker Compose
              run: |
                   docker compose up -d --build
            
            - name: Verificar se Subiu
              run: |
                   sleep 10
                   docker compose ps
